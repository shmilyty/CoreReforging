# 升级失败机制说明

## 功能概述

军用和传奇装备升级时存在失败风险：
- **成功率**：60%
- **失败率**：40%
- **失败惩罚**：EXP 被消耗，但装备等级不提升

## 升级成功率

| 稀有度 | 成功率 | 失败率 | 说明 |
|--------|--------|--------|------|
| 损坏 (BROKEN) | 100% | 0% | 必定成功 |
| 普通 (STANDARD) | 100% | 0% | 必定成功 |
| 军用 (MILITARY) | 60% | 40% | 有失败风险 |
| 传奇 (LEGENDARY) | 60% | 40% | 有失败风险 |

## 实现细节

### 1. 核心逻辑

**GameCore.h - Equipment 基类**
```cpp
virtual bool levelUp() = 0;  // 返回 true 表示成功，false 表示失败
virtual int getUpgradeSuccessRate() const = 0;  // 获取成功率
```

**Weapon/Armor 类**
```cpp
int getUpgradeSuccessRate() const {
    if (rarity == Rarity::MILITARY || rarity == Rarity::LEGENDARY) {
        return 60;  // 军用和传奇 60% 成功率
    }
    return 100;  // 其他 100% 成功率
}

bool levelUp() {
    if (!canLevelUp()) {
        return false;
    }
    
    // 军用和传奇装备有失败风险
    if (rarity == Rarity::MILITARY || rarity == Rarity::LEGENDARY) {
        int roll = rand() % 100;  // 0-99
        if (roll < 60) {
            level++;
            return true;  // 成功
        } else {
            return false;  // 失败
        }
    }
    
    // 其他装备必定成功
    level++;
    return true;
}
```

### 2. 随机数机制

**概率分布**：
- 生成 0-99 的随机数
- 0-59 (60个数) → 成功 (60%)
- 60-99 (40个数) → 失败 (40%)

**随机数生成**：
```cpp
int roll = rand() % 100;
if (roll < 60) {
    // 成功
} else {
    // 失败
}
```

### 3. 用户界面

#### 装备列表显示

**损坏/普通装备**：
```
[0] 制式步枪 [武器] | 等级: 1/3 | 升级消耗: 20 EXP [可升级]
```

**军用/传奇装备**：
```
[1] 等离子光剑 [武器] | 等级: 1/3 | 升级消耗: 30 EXP | 成功率: 60% [可升级]
[2] 传奇狙击炮 [武器] | 等级: 2/3 | 升级消耗: 40 EXP | 成功率: 60% [可升级]
```

#### 升级过程

**成功时**：
```
[提示] 该装备升级成功率: 60%
消耗 30 EXP，剩余 970 EXP。

正在尝试升级...

★ 升级成功！ ★
等离子光剑 已升级到 Lv.2！

新属性：
  攻击力: 144
  暴击率: 30%
  攻击速度: 1 回合/次
  战斗力: 2160
```

**失败时**：
```
[提示] 该装备升级成功率: 60%
消耗 30 EXP，剩余 970 EXP。

正在尝试升级...

✗ 升级失败... ✗
等离子光剑 保持在 Lv.1
EXP 已消耗，但装备等级未提升。
```

## 修改的文件

### 1. GameCore.h

**Equipment 基类**：
- 修改 `levelUp()` 返回类型：`void` → `bool`
- 新增 `getUpgradeSuccessRate()` 纯虚函数

**Weapon 类**：
- 实现 `getUpgradeSuccessRate()` 方法
- 修改 `levelUp()` 方法，添加失败机制

**Armor 类**：
- 实现 `getUpgradeSuccessRate()` 方法
- 修改 `levelUp()` 方法，添加失败机制

### 2. main.cpp

**装备升级界面 (case 3)**：
- 显示升级成功率（如果 < 100%）
- 调用 `levelUp()` 并检查返回值
- 根据成功/失败显示不同的消息
- 失败时 EXP 已扣除但等级不变

**修改位置**：
- 武器升级逻辑（第 612-652 行）
- 装甲升级逻辑（第 653-693 行）
- 装备列表显示（第 544-565 行）

### 3. Adventure.h

**篝火升级功能**：
- 显示升级成功率（如果 < 100%）
- 调用 `levelUp()` 并检查返回值
- 根据成功/失败显示不同的消息
- 失败时 EXP 已扣除但等级不变

**修改位置**：
- `campfireEquipmentUpgrade()` 方法（第 396-420 行）
- 装备列表显示（第 376-390 行）

## 游戏平衡性分析

### EXP 成本分析

**军用装备 (稀有度 2)**：
- 升级消耗：30 EXP
- 期望成本：30 / 0.6 = 50 EXP（考虑失败）
- 实际成本：30-150 EXP（取决于运气）

**传奇装备 (稀有度 3)**：
- 升级消耗：40 EXP
- 期望成本：40 / 0.6 ≈ 67 EXP（考虑失败）
- 实际成本：40-200 EXP（取决于运气）

### 升级次数期望

**从 Lv.1 升到 Lv.3**：
- 需要成功 2 次
- 期望尝试次数：2 / 0.6 ≈ 3.33 次
- 期望总消耗：
  - 军用：30 × 3.33 ≈ 100 EXP
  - 传奇：40 × 3.33 ≈ 133 EXP

### 概率分布

**连续升级成功概率**：
- 1 次成功：60%
- 2 次连续成功：36% (0.6 × 0.6)
- 3 次连续成功：21.6% (0.6³)

**至少失败一次的概率**：
- 升 2 级至少失败 1 次：64% (1 - 0.36)
- 升 2 级至少失败 2 次：28.8%

## 策略建议

### 1. 升级时机
- **EXP 充足时**：可以承受多次失败
- **EXP 紧张时**：优先升级低稀有度装备

### 2. 装备选择
- **损坏/普通装备**：无风险，优先升级
- **军用装备**：中等风险，性价比较高
- **传奇装备**：高风险高回报，需要充足 EXP

### 3. 篝火升级
- 篝火处可以使用"未结算的 EXP"
- 适合在 EXP 充足时尝试高风险升级
- 失败后可以继续战斗获取更多 EXP

### 4. 心理准备
- 预期会有失败
- 准备 1.5-2 倍的 EXP 预算
- 不要在 EXP 不足时强行升级

## 用户体验

### 正面体验
1. **增加策略深度**：需要权衡风险与收益
2. **增加紧张感**：升级时的期待和悬念
3. **成功时的满足感**：克服概率获得成功
4. **稀有装备更有价值**：升级难度体现稀有度

### 负面体验（已优化）
1. **失败提示清晰**：明确告知失败原因
2. **成功率可见**：玩家可以做出知情决策
3. **EXP 不会白费**：虽然失败但装备保留
4. **无装备损坏**：失败不会降级或损坏装备

## 测试场景

### 测试 1：损坏装备升级
```
选择损坏装备 → 升级 → 必定成功
```
**预期**：无成功率提示，直接升级成功

### 测试 2：军用装备升级
```
选择军用装备 → 升级 → 60% 成功
```
**预期**：显示"成功率: 60%"，可能成功或失败

### 测试 3：连续升级失败
```
选择传奇装备 → 连续升级 5 次
```
**预期**：部分成功，部分失败，EXP 持续消耗

### 测试 4：篝火升级
```
冒险 → 篝火 → 装备升级 → 选择军用装备
```
**预期**：使用未结算 EXP，可能成功或失败

## 技术细节

### 随机数种子
- 使用 `rand()` 函数
- 需要在 main 函数中初始化种子：`srand(time(nullptr))`
- 每次运行游戏结果不同

### 线程安全
- 当前实现为单线程
- `rand()` 在单线程环境下安全

### 可扩展性
- 成功率可以轻松调整（修改 60 这个常量）
- 可以为不同等级设置不同成功率
- 可以添加成功率提升道具

## 未来改进建议

1. **保底机制**：连续失败 N 次后必定成功
2. **成功率道具**：使用道具提升成功率
3. **失败补偿**：失败时返还部分 EXP
4. **升级历史**：记录每件装备的升级尝试次数
5. **成就系统**：连续成功/失败的成就

## 总结

升级失败机制为游戏增加了：
- ✅ 策略深度
- ✅ 风险管理
- ✅ 紧张感和期待感
- ✅ 稀有装备的价值感
- ✅ 清晰的用户反馈

同时保持了：
- ✅ 公平性（概率透明）
- ✅ 可预测性（成功率可见）
- ✅ 无惩罚性（装备不会损坏）
- ✅ 良好的用户体验

