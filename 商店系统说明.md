# 商店系统说明 (Ver 1.0)

## 系统概述

游戏中有两个独立的商店：
1. **基地商店** - 位于主菜单，随时可以访问
2. **篝火商店** - 位于冒险中的篝火休息点

## 商店机制

### 商品生成
- 每个商店随机展示 **3 件装备**（可能是武器或装甲）
- 商品从游戏中所有装备模板中随机选择
- 每件商品的价格 = `500 × (稀有度等级 + 1)` EXP

### 价格表

| 稀有度 | 稀有度等级 | 价格 |
|--------|-----------|------|
| 损坏 (BROKEN) | 0 | 500 EXP |
| 普通 (STANDARD) | 1 | 1000 EXP |
| 军用 (MILITARY) | 2 | 1500 EXP |
| 传奇 (LEGENDARY) | 3 | 2000 EXP |

### 商店刷新规则

#### 基地商店
- **初次访问**：自动生成 3 件商品
- **购买后**：商品立即从列表中移除，但不会立即补充
- **刷新时机**：完成一次冒险（无论成功或失败）后，商店重新生成 3 件商品

#### 篝火商店
- **初次到达篝火**：自动生成 3 件商品
- **购买后**：商品立即从列表中移除，但不会立即补充
- **刷新时机**：
  - 同一次冒险中多次到达篝火，商店不会刷新
  - 下一次冒险开始时，篝火商店重新生成 3 件商品

## 使用方法

### 基地商店
```
主菜单 → [5] 访问商店 (Shop)
```

1. 查看当前商品列表和价格
2. 输入 `1-3` 购买对应商品
3. 输入 `0` 返回主菜单

### 篝火商店
```
冒险中 → 到达篝火 → [3] 访问商店
```

1. 查看当前商品列表和价格
2. 输入 `1-3` 购买对应商品
3. 输入 `0` 返回篝火菜单

**注意**：在篝火处购买时，可以使用"本次冒险已获得的 EXP"（尚未结算的 EXP）

## 商店显示

商品显示格式：
```
[1] 等离子光剑 (武器) | 攻击:120 | 暴击率:25% | 攻速:1 | 重量:5 | 价格: 1500 EXP
[2] 反应堆外壳 (装甲) | HP:500 | 闪避率:15% | 承重:15 | 价格: 1500 EXP
[3] 生锈的铁管 (武器) | 攻击:15 | 暴击率:5% | 攻速:3 | 重量:2 | 价格: 500 EXP
```

- 武器名称根据稀有度显示不同颜色
- 显示装备的关键属性
- 显示购买价格

## 存档系统

### 商店状态保存
- 商店状态（当前商品、是否需要刷新）会保存在 `saves/shop_slot_X.json` 中
- 与游戏进度存档（`saves/save_slot_X.json`）分开存储
- 退出游戏或手动存档时自动保存商店状态

### 商店状态加载
- 加载存档时自动恢复商店状态
- 如果没有商店存档，基地商店会自动刷新

## 策略建议

1. **EXP 管理**：
   - 在基地购买装备会消耗 EXP，影响装备升级
   - 在篝火购买装备可以使用"未结算的 EXP"，但会减少最终收益

2. **刷新机制**：
   - 如果基地商店没有想要的装备，可以进行一次快速冒险来刷新
   - 篝火商店在同一次冒险中不会刷新，需要重新开始冒险

3. **购买时机**：
   - 基地：适合在有足够 EXP 时购买强力装备
   - 篝火：适合在冒险中获得大量 EXP 后，临时补充装备

## 技术实现

### 文件结构
```
Shop.h          - 商店类定义和逻辑
main.cpp        - 基地商店集成、商店状态保存/加载
Adventure.h     - 篝火商店集成
SaveManager.h   - 提供装备模板访问接口
```

### 关键类和方法
- `Shop::refresh()` - 刷新商店商品
- `Shop::display()` - 显示商店界面
- `Shop::buyItem()` - 购买商品
- `Shop::markNeedsRefresh()` - 标记需要刷新
- `Shop::toJson()` / `Shop::fromJson()` - 序列化/反序列化

### 数据流
```
游戏启动
  ↓
加载装备模板 (SaveManager::getAllEquipmentTemplates)
  ↓
初始化商店 (baseShop, campfireShop)
  ↓
加载商店状态 (loadShopStates)
  ↓
游戏循环
  ├─ 访问基地商店 → 购买 → 标记需要刷新
  ├─ 开始冒险 → 篝火商店 → 购买
  └─ 冒险结束 → 刷新基地商店
  ↓
退出/存档
  ↓
保存商店状态 (saveShopStates)
```

## 版本历史

- **Ver 1.0** - 初始实现
  - 基地商店和篝火商店
  - 随机商品生成
  - 基于稀有度的定价
  - 商店状态持久化
  - 智能刷新机制

