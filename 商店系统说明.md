# 商店系统说明 (Ver 1.0)

## 系统概述

游戏中有两个独立的商店：
1. **基地商店** - 位于主菜单，随时可以访问
2. **篝火商店** - 位于冒险中的篝火休息点

## 商店机制

### 商品生成
- 每个商店随机展示 **3 件不重复的装备**（可能是武器或装甲）
- 商品根据稀有度概率随机选择：
  - **损坏 (BROKEN)**: 50% 概率
  - **普通 (STANDARD)**: 30% 概率
  - **军用 (MILITARY)**: 15% 概率
  - **传奇 (LEGENDARY)**: 5% 概率
- 每件商品的价格 = `500 × (稀有度等级 + 1)` EXP
- **防重复机制**：同一次刷新中，3 件商品不会重复（ID 不同）

### 价格表

| 稀有度 | 稀有度等级 | 价格 |
|--------|-----------|------|
| 损坏 (BROKEN) | 0 | 500 EXP |
| 普通 (STANDARD) | 1 | 1000 EXP |
| 军用 (MILITARY) | 2 | 1500 EXP |
| 传奇 (LEGENDARY) | 3 | 2000 EXP |

### 商店刷新规则

#### 自然刷新（免费）

**基地商店**
- **初次访问**：自动生成 3 件商品
- **购买后**：商品立即从列表中移除，但不会立即补充
- **自然刷新时机**：完成一次冒险（无论成功或失败）后，商店重新生成 3 件商品

**篝火商店**
- **初次到达篝火**：自动生成 3 件商品
- **购买后**：商品立即从列表中移除，但不会立即补充
- **自然刷新时机**：
  - 同一次冒险中多次到达篝火，商店不会刷新
  - 下一次冒险开始时，篝火商店重新生成 3 件商品

#### 手动刷新（付费）

**刷新费用机制**
- **初始费用**：50 EXP
- **递增规则**：每次手动刷新后，下次费用翻倍
  - 第 1 次：50 EXP
  - 第 2 次：100 EXP
  - 第 3 次：200 EXP
  - 第 4 次：400 EXP
  - 第 5 次：800 EXP
  - 以此类推...
- **费用重置**：自然刷新后，手动刷新费用重置为 50 EXP

**使用场景**
- 当前商店商品不满意时，可以花费 EXP 立即刷新
- 基地商店和篝火商店的刷新费用独立计算
- 篝火商店可以使用"未结算的 EXP"进行手动刷新

## 使用方法

### 基地商店
```
主菜单 → [5] 访问商店 (Shop)
```

1. 查看当前商品列表和价格
2. 输入 `1-3` 购买对应商品
3. 输入 `4` 手动刷新商店（花费 EXP）
4. 输入 `0` 返回主菜单

### 篝火商店
```
冒险中 → 到达篝火 → [3] 访问商店
```

1. 查看当前商品列表和价格
2. 输入 `1-3` 购买对应商品
3. 输入 `4` 手动刷新商店（花费 EXP）
4. 输入 `0` 返回篝火菜单

**注意**：在篝火处购买和刷新时，可以使用"本次冒险已获得的 EXP"（尚未结算的 EXP）

## 商店显示

商品显示格式：
```
========== 商店 ==========
[1] 等离子光剑 (武器) | 攻击:120 | 暴击率:25% | 攻速:1 | 重量:5 | 价格: 1500 EXP
[2] 反应堆外壳 (装甲) | HP:500 | 闪避率:15% | 承重:15 | 价格: 1500 EXP
[3] 生锈的铁管 (武器) | 攻击:15 | 暴击率:5% | 攻速:3 | 重量:2 | 价格: 500 EXP
==========================
[提示] 手动刷新费用: 50 EXP

当前 EXP: 2500

[1-3] 购买对应商品 | [4] 手动刷新 (50 EXP) | [0] 返回主菜单
>>> 请选择:
```

显示特点：
- 武器名称根据稀有度显示不同颜色（白/绿/红/黄）
- 显示装备的关键属性（攻击力、暴击率等）
- 显示购买价格
- 显示当前手动刷新费用
- 提供购买、刷新、返回三种操作

## 存档系统

### 商店状态保存
- 商店状态（当前商品、是否需要刷新）会保存在 `saves/shop_slot_X.json` 中
- 与游戏进度存档（`saves/save_slot_X.json`）分开存储
- 退出游戏或手动存档时自动保存商店状态

### 商店状态加载
- 加载存档时自动恢复商店状态
- 如果没有商店存档，基地商店会自动刷新

## 策略建议

### EXP 管理
- **基地购买**：消耗已结算的 EXP，影响装备升级
- **篝火购买**：可以使用"未结算的 EXP"，但会减少最终收益
- **手动刷新**：费用递增，需要权衡成本与收益

### 刷新策略
1. **免费刷新（推荐）**：
   - 基地商店：进行一次快速冒险即可免费刷新
   - 篝火商店：下次冒险开始时自动刷新
   
2. **付费刷新（谨慎使用）**：
   - 第 1-2 次刷新（50-100 EXP）：成本较低，可以尝试
   - 第 3 次及以后（200+ EXP）：成本较高，需要慎重考虑
   - 建议：连续刷新不超过 2-3 次，否则等待自然刷新更划算

### 稀有度概率
- **损坏装备**：最常见（50%），价格便宜（500 EXP）
- **普通装备**：较常见（30%），性价比高（1000 EXP）
- **军用装备**：较稀有（15%），性能优秀（1500 EXP）
- **传奇装备**：非常稀有（5%），顶级装备（2000 EXP）

### 购买时机
- **基地商店**：适合在有足够 EXP 时购买强力装备
- **篝火商店**：适合在冒险中获得大量 EXP 后，临时补充装备
- **刷新时机**：如果连续 2-3 次刷新都没有想要的装备，建议等待自然刷新

## 技术实现

### 文件结构
```
Shop.h          - 商店类定义和逻辑
main.cpp        - 基地商店集成、商店状态保存/加载
Adventure.h     - 篝火商店集成
SaveManager.h   - 提供装备模板访问接口
```

### 关键类和方法
- `Shop::refresh()` - 自然刷新商店商品（免费，重置手动刷新费用）
- `Shop::manualRefresh()` - 手动刷新商店商品（付费，费用翻倍）
- `Shop::display()` - 显示商店界面
- `Shop::buyItem()` - 购买商品
- `Shop::selectEquipmentByRarity()` - 根据稀有度概率选择装备
- `Shop::getManualRefreshCost()` - 获取当前手动刷新费用
- `Shop::markNeedsRefresh()` - 标记需要刷新
- `Shop::toJson()` / `Shop::fromJson()` - 序列化/反序列化（包括刷新费用）

### 数据流
```
游戏启动
  ↓
加载装备模板 (SaveManager::getAllEquipmentTemplates)
  ↓
初始化商店 (baseShop, campfireShop)
  ↓
加载商店状态 (loadShopStates)
  ↓
游戏循环
  ├─ 访问基地商店 → 购买 → 标记需要刷新
  ├─ 开始冒险 → 篝火商店 → 购买
  └─ 冒险结束 → 刷新基地商店
  ↓
退出/存档
  ↓
保存商店状态 (saveShopStates)
```

## 版本历史

- **Ver 1.0** - 完整商店系统
  - 基地商店和篝火商店
  - 基于稀有度概率的商品生成（50%/30%/15%/5%）
  - 防重复机制（同一批次 3 件商品不重复）
  - 基于稀有度的定价（500/1000/1500/2000 EXP）
  - 手动刷新功能（50 EXP 起，递增翻倍）
  - 自然刷新重置手动刷新费用
  - 商店状态完整持久化（包括刷新费用）
  - 智能刷新机制

## 更新日志

### Ver 1.0 改进
1. **防重复机制**：同一次刷新的 3 件商品不会重复
2. **稀有度概率**：
   - 损坏 50%、普通 30%、军用 15%、传奇 5%
   - 更符合游戏平衡性
3. **手动刷新功能**：
   - 初始 50 EXP，每次翻倍
   - 自然刷新后重置为 50 EXP
   - 基地和篝火商店独立计费
4. **持久化增强**：手动刷新费用也会保存到存档

