# 存档恢复系统说明

## 功能概述

游戏现在具备完整的存档容错和自动修复功能，可以处理以下异常情况：
1. ✅ `saves` 文件夹不存在
2. ✅ 存档文件丢失
3. ✅ 存档文件损坏（JSON 解析失败）
4. ✅ 存档文件缺少必要字段
5. ✅ 商店存档损坏或丢失

## 实现细节

### 1. 文件夹自动创建

**功能**：`SaveManager::ensureSavesFolderExists()`

**触发时机**：
- 游戏启动时调用 `initializeSaveSlots()` 时自动检查

**处理逻辑**：
```cpp
1. 检查 saves 文件夹是否存在
2. 如果不存在，自动创建
3. 如果存在但不是文件夹（是文件），提示用户手动删除
```

**输出提示**：
```
[系统] 已创建 saves 文件夹。
```

### 2. 存档文件自动创建/修复

**功能**：增强的 `SaveManager::initializeSaveSlots()`

**检查项目**：
- 文件是否存在
- JSON 是否可以解析
- 必要字段是否完整（`player_name`, `exp`, `inventory`, `equipment_config`）

**处理流程**：
```
对于每个存档槽位 (1-3):
  ├─ 尝试打开文件
  │   ├─ 文件不存在 → 创建空存档
  │   └─ 文件存在 → 继续检查
  │
  ├─ 尝试解析 JSON
  │   ├─ 解析失败 → 重建存档
  │   └─ 解析成功 → 继续检查
  │
  ├─ 检查必要字段
  │   ├─ 缺少字段 → 重建存档
  │   └─ 字段完整 → 存档正常
  │
  └─ 创建/重建空存档
      ├─ player_name: ""
      ├─ exp: 0
      ├─ inventory: []
      └─ equipment_config: {armor_id: -1, weapon_ids: []}
```

**输出提示**：
```
[系统] 存档槽 1 不存在，正在创建...
[系统] 存档槽 1 已创建。

[警告] 存档槽 2 损坏（JSON 解析失败），正在重建...
[系统] 存档槽 2 已创建。

[警告] 存档槽 3 损坏（缺少必要字段），正在重建...
[系统] 存档槽 3 已创建。
```

### 3. 存档加载容错

**功能**：增强的 `SaveManager::loadSave()`

**异常处理**：
```cpp
try {
    // 解析 JSON
    json j = json::parse(f);
    
    // 检查必要字段
    if (!j.contains("player_name") || !j.contains("inventory")) {
        // 缺少字段，视为损坏
        return empty_result;
    }
    
    // 正常加载
    ...
} catch (json::parse_error& e) {
    // JSON 解析失败
    return empty_result;
} catch (...) {
    // 其他异常
    return empty_result;
}
```

**输出提示**：
```
[提示] 存档槽 1 为空，将开始新游戏。

[警告] 存档槽 2 损坏（JSON 解析失败），将开始新游戏。
[详细] parse error at line 1, column 2: syntax error while parsing object key

[警告] 存档槽 3 损坏（缺少必要字段），将开始新游戏。
```

### 4. 存档显示容错

**功能**：增强的 `SaveManager::showSaveSlots()`

**异常处理**：
```cpp
for each slot:
    if (isSlotEmpty(slot)) {
        显示 "空槽位"
    } else {
        try {
            读取并显示存档信息
        } catch (json::parse_error& e) {
            显示 "损坏的存档（将在选择后自动修复）"
        } catch (...) {
            显示 "无法读取（将在选择后自动修复）"
        }
    }
```

**输出示例**：
```
=== 存档槽位 ===
[1] 存档 1 - 玩家A (EXP: 1500, 装备: 8件)
[2] 存档 2 - 空槽位
[3] 存档 3 - 损坏的存档（将在选择后自动修复）
===================
```

### 5. 商店存档容错

**功能**：增强的 `loadShopStates()`

**异常处理**：
```cpp
try {
    json shopJson = json::parse(f);
    
    if (shopJson.contains("base_shop")) {
        baseShop.fromJson(shopJson["base_shop"], templates);
    } else {
        // 缺少基地商店数据
        baseShop.refresh();
    }
    
    if (shopJson.contains("campfire_shop")) {
        campfireShop.fromJson(shopJson["campfire_shop"], templates);
    } else {
        // 缺少篝火商店数据（不是错误）
    }
} catch (json::parse_error& e) {
    // JSON 解析失败
    baseShop.refresh();
} catch (...) {
    // 其他异常
    baseShop.refresh();
}
```

**输出提示**：
```
[系统] 商店存档不存在，正在初始化新商店。

[警告] 商店存档损坏（JSON 解析失败），正在重新初始化。
[详细] parse error at line 5, column 10: unexpected end of input

[警告] 基地商店数据缺失，正在重新初始化。
[提示] 篝火商店数据缺失，将在首次冒险时初始化。
```

## 修改的文件

### 1. SaveManager.h

**新增头文件**：
```cpp
#include <sys/stat.h>  // 用于检查文件夹是否存在
#include <direct.h>    // Windows 下创建文件夹
```

**新增方法**：
```cpp
static void ensureSavesFolderExists()
```

**增强方法**：
- `initializeSaveSlots()` - 添加完整的存档检查和修复逻辑
- `isSlotEmpty()` - 添加异常处理
- `showSaveSlots()` - 添加异常处理
- `loadSave()` - 添加完整的异常处理和字段检查

### 2. main.cpp

**增强函数**：
- `loadShopStates()` - 添加完整的异常处理

## 测试场景

### 场景 1：saves 文件夹不存在

**操作**：
```bash
# 删除 saves 文件夹
rmdir /s /q saves

# 启动游戏
game_new.exe
```

**预期结果**：
```
[系统] 已创建 saves 文件夹。
[系统] 存档槽 1 不存在，正在创建...
[系统] 存档槽 1 已创建。
[系统] 存档槽 2 不存在，正在创建...
[系统] 存档槽 2 已创建。
[系统] 存档槽 3 不存在，正在创建...
[系统] 存档槽 3 已创建。

=== 存档槽位 ===
[1] 存档 1 - 空槽位
[2] 存档 2 - 空槽位
[3] 存档 3 - 空槽位
===================
```

### 场景 2：存档文件损坏

**操作**：
```bash
# 手动损坏存档文件
echo {invalid json > saves\save_slot_1.json

# 启动游戏
game_new.exe
```

**预期结果**：
```
[警告] 存档槽 1 损坏（JSON 解析失败），正在重建...
[系统] 存档槽 1 已创建。

=== 存档槽位 ===
[1] 存档 1 - 空槽位
[2] 存档 2 - 玩家A (EXP: 1500, 装备: 8件)
[3] 存档 3 - 玩家B (EXP: 500, 装备: 5件)
===================
```

### 场景 3：存档文件缺少字段

**操作**：
```bash
# 创建不完整的存档文件
echo {"player_name": "测试"} > saves\save_slot_2.json

# 启动游戏
game_new.exe
```

**预期结果**：
```
[警告] 存档槽 2 损坏（缺少必要字段），正在重建...
[系统] 存档槽 2 已创建。

=== 存档槽位 ===
[1] 存档 1 - 玩家A (EXP: 1500, 装备: 8件)
[2] 存档 2 - 空槽位
[3] 存档 3 - 玩家B (EXP: 500, 装备: 5件)
===================
```

### 场景 4：商店存档损坏

**操作**：
```bash
# 损坏商店存档
echo {invalid > saves\shop_slot_1.json

# 启动游戏并选择存档 1
game_new.exe
```

**预期结果**：
```
[警告] 商店存档损坏（JSON 解析失败），正在重新初始化。
[详细] parse error at line 1, column 9: syntax error while parsing value
[系统] 商店已刷新！
```

### 场景 5：加载损坏的存档

**操作**：
```bash
# 在存档显示界面选择损坏的存档
```

**预期结果**：
```
=== 存档槽位 ===
[1] 存档 1 - 玩家A (EXP: 1500, 装备: 8件)
[2] 存档 2 - 损坏的存档（将在选择后自动修复）
[3] 存档 3 - 玩家B (EXP: 500, 装备: 5件)
===================

请选择存档槽位 (1-3): 2

[警告] 存档槽 2 损坏（JSON 解析失败），将开始新游戏。
[详细] parse error at line 1, column 2: syntax error while parsing object key
请输入新驾驶员代号: 
```

## 错误类型和处理

### 错误类型 1：文件系统错误
- **原因**：文件夹不存在、权限不足
- **处理**：自动创建文件夹，提示用户
- **恢复**：完全自动，无需用户干预

### 错误类型 2：JSON 解析错误
- **原因**：文件内容不是有效的 JSON
- **处理**：捕获 `json::parse_error` 异常
- **恢复**：重建空存档或刷新商店

### 错误类型 3：数据完整性错误
- **原因**：JSON 有效但缺少必要字段
- **处理**：检查关键字段是否存在
- **恢复**：重建空存档或刷新商店

### 错误类型 4：其他未知错误
- **原因**：其他运行时异常
- **处理**：捕获所有异常 `catch (...)`
- **恢复**：重建空存档或刷新商店

## 用户体验

### 正常情况
- 无感知，游戏正常运行
- 存档正常加载和保存

### 异常情况
- 清晰的错误提示
- 自动修复，无需手动干预
- 详细的错误信息（用于调试）
- 优雅降级（损坏存档 → 新游戏）

### 提示信息层级

**[系统]** - 正常操作提示
```
[系统] 已创建 saves 文件夹。
[系统] 存档槽 1 已创建。
```

**[提示]** - 信息性提示
```
[提示] 存档槽 1 为空，将开始新游戏。
[提示] 篝火商店数据缺失，将在首次冒险时初始化。
```

**[警告]** - 非致命错误
```
[警告] 存档槽 2 损坏（JSON 解析失败），正在重建...
[警告] 商店存档损坏，正在重新初始化。
```

**[错误]** - 严重错误
```
[错误] 无法创建存档槽 1！
[错误] saves 存在但不是文件夹！请手动删除 saves 文件。
```

**[详细]** - 调试信息
```
[详细] parse error at line 1, column 2: syntax error while parsing object key
```

## 技术实现

### 文件夹检查（跨平台）
```cpp
struct stat info;
if (stat("saves", &info) != 0) {
    // 文件夹不存在
    #ifdef _WIN32
        _mkdir("saves");
    #else
        mkdir("saves", 0755);
    #endif
}
```

### JSON 解析容错
```cpp
try {
    json j = json::parse(f);
    // 正常处理
} catch (json::parse_error& e) {
    // JSON 格式错误
    cout << "[警告] 解析失败" << endl;
    cout << "[详细] " << e.what() << endl;
} catch (...) {
    // 其他异常
    cout << "[警告] 读取失败" << endl;
}
```

### 字段完整性检查
```cpp
if (!j.contains("player_name") || 
    !j.contains("exp") || 
    !j.contains("inventory")) {
    // 缺少必要字段
    return empty_result;
}
```

## 优势

1. **健壮性**：能处理各种异常情况
2. **自动化**：无需用户手动修复
3. **透明性**：清晰的错误提示
4. **安全性**：不会因存档问题导致崩溃
5. **可维护性**：统一的错误处理模式

## 局限性

1. **数据丢失**：损坏的存档无法恢复，只能重建
2. **平台依赖**：文件夹创建需要平台特定代码
3. **权限问题**：如果没有写入权限，仍然会失败

## 未来改进建议

1. **存档备份**：定期自动备份存档
2. **数据恢复**：尝试从损坏的存档中恢复部分数据
3. **云存档**：支持云端存档同步
4. **存档验证**：保存时添加校验和
5. **存档历史**：保留多个历史版本

## 总结

存档恢复系统提供了完整的容错机制，确保游戏在各种异常情况下都能正常运行。用户不需要担心存档丢失或损坏的问题，系统会自动检测并修复。

