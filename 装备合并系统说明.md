# 装备合并系统说明

## 功能概述

装备合并系统允许玩家将两件装备合并成一件更高稀有度的新装备。

## 合并规则

### 必要条件（全部满足）

1. **势力相同**：两件装备必须来自同一势力
   - 共和国 + 共和国 ✅
   - 帝国 + 帝国 ✅
   - 共和国 + 帝国 ✗

2. **类型相同**：必须同时是武器或同时是装甲
   - 武器 + 武器 ✅
   - 装甲 + 装甲 ✅
   - 武器 + 装甲 ✗

3. **非传奇装备**：不能合并传奇级别的装备
   - 损坏 + 损坏 ✅
   - 普通 + 普通 ✅
   - 军用 + 军用 ✅
   - 传奇 + 任何 ✗

4. **未装备**：不能合并已装备在身上的装备
   - 背包中的装备 ✅
   - 已装备的装备 ✗

### 合并结果

**消耗**：
- 两件原装备被消耗（从背包中移除并删除）

**获得**：
- 一件新装备，属性如下：
  - **势力**：与原装备相同
  - **类型**：与原装备相同（武器或装甲）
  - **等级**：1
  - **稀有度**：`max(装备1稀有度, 装备2稀有度) + 1`
  - **具体装备**：从该势力该类型的装备中随机选择

## 稀有度提升规则

| 装备1稀有度 | 装备2稀有度 | 新装备稀有度 |
|------------|------------|-------------|
| 损坏 (0) | 损坏 (0) | 普通 (1) |
| 损坏 (0) | 普通 (1) | 军用 (2) |
| 损坏 (0) | 军用 (2) | 传奇 (3) |
| 普通 (1) | 普通 (1) | 军用 (2) |
| 普通 (1) | 军用 (2) | 传奇 (3) |
| 军用 (2) | 军用 (2) | 传奇 (3) |

**注意**：稀有度最高为传奇，不会超过传奇。

## 使用方法

### 1. 进入合并界面

```
主菜单 → [6] 装备合并 (Merge)
```

### 2. 查看可合并装备

系统会自动筛选出符合条件的装备：
- 未装备的装备
- 非传奇装备

```
可合并的装备：
[0] 制式步枪 [武器] | 势力: 共和国 | 等级: 1
[1] 等离子光剑 [武器] | 势力: 帝国 | 等级: 2
[2] 皮革背心 [装甲] | 势力: 帝国 | 等级: 1
[3] 破损铁甲 [装甲] | 势力: 废土 | 等级: 1
```

### 3. 选择装备

```
请选择第一件装备 (输入-1取消): 0
请选择第二件装备 (输入-1取消): 1
```

### 4. 查看合并预览

```
=== 合并预览 ===
装备1: 制式步枪
装备2: 等离子光剑
势力: 共和国
新稀有度: 传奇

确认合并？(1=是, 0=否): 
```

### 5. 确认合并

```
正在合并装备...

★ 合并成功！ ★
获得: 传奇狙击炮
等级: 1
[武器] 攻击: 300 | 暴击率: 50% | 速度: 5回合/次 | 重量: 8 | 势力: 共和国
```

## 错误提示

### 装备不足
```
可合并的装备不足2件！
（需要至少2件未装备的非传奇装备）
```

### 类型不匹配
```
合并失败：两件装备必须同时是武器或同时是装甲！
```

### 势力不匹配
```
合并失败：两件装备必须来自同一势力！
装备1势力: 共和国
装备2势力: 帝国
```

### 选择相同装备
```
不能选择同一件装备！
```

## 实现细节

### 1. 装备筛选

```cpp
// 筛选可合并的装备
for (auto eq : inventory) {
    // 检查是否已装备
    bool isEquipped = false;
    if (eq == equipSlot.equippedArmor) {
        isEquipped = true;
    }
    for (auto w : equipSlot.equippedWeapons) {
        if (eq == w) {
            isEquipped = true;
            break;
        }
    }
    
    // 只添加未装备且非传奇的装备
    if (!isEquipped && eq->getRarity() != Rarity::LEGENDARY) {
        mergeableEquipment.push_back(eq);
    }
}
```

### 2. 条件检查

```cpp
// 检查类型
bool sameType = (w1 && w2) || (a1 && a2);

// 检查势力
if (eq1->getFaction() != eq2->getFaction()) {
    // 失败
}
```

### 3. 稀有度计算

```cpp
Rarity newRarity = static_cast<Rarity>(
    max(static_cast<int>(eq1->getRarity()), 
        static_cast<int>(eq2->getRarity())) + 1
);

// 限制最高为传奇
if (newRarity > Rarity::LEGENDARY) {
    newRarity = Rarity::LEGENDARY;
}
```

### 4. 随机选择装备

```cpp
// 从该势力的装备中筛选
vector<Equipment*> factionEquipment;
for (auto tmpl : allTemplates) {
    if (tmpl->getFaction() == eq1->getFaction()) {
        // 检查类型匹配
        if ((w1 && tw) || (a1 && ta)) {
            factionEquipment.push_back(tmpl);
        }
    }
}

// 随机选择
srand(time(nullptr));
int randomIdx = rand() % factionEquipment.size();
Equipment* selectedTemplate = factionEquipment[randomIdx];
```

### 5. 创建新装备

```cpp
if (tw) {
    newEquipment = new Weapon(
        tw->getId(),
        tw->getName(),
        newRarity,  // 新稀有度
        1,          // 等级1
        tw->getFaction(),
        tw->getBaseAtk(),
        tw->getBaseCritRate(),
        tw->getBaseAtkSpeed(),
        tw->getWeight()
    );
}
```

### 6. 更新背包

```cpp
// 移除旧装备
inventory.erase(remove(inventory.begin(), inventory.end(), eq1), 
                inventory.end());
inventory.erase(remove(inventory.begin(), inventory.end(), eq2), 
                inventory.end());

// 删除旧装备
delete eq1;
delete eq2;

// 添加新装备
inventory.push_back(newEquipment);
```

## 修改的文件

### 1. main.cpp

**新增功能**：
- 主菜单添加 `[6] 装备合并 (Merge)` 选项
- 实现 `case 6` 的完整合并逻辑
- 手动存档改为 `case 7`

**新增头文件**：
```cpp
#include <algorithm>  // 用于 remove
#include <ctime>      // 用于 time
```

### 2. GameCore.h

**新增方法**：
```cpp
string getFaction() const { return faction; }
```

## 策略建议

### 1. 何时合并

**优势**：
- 获得更高稀有度的装备
- 清理低级装备，节省背包空间

**劣势**：
- 失去两件装备
- 新装备等级为1，需要重新升级
- 随机性，可能得到不想要的装备

### 2. 合并策略

**推荐合并**：
- 两件低等级的损坏装备 → 获得普通装备
- 两件普通装备 → 获得军用装备
- 不需要的装备 → 尝试获得更好的装备

**不推荐合并**：
- 已升级的高等级装备（浪费升级投入）
- 唯一的某类型装备（可能需要使用）
- 传奇装备（无法合并）

### 3. 势力管理

- 收集同势力的装备便于合并
- 不同势力的装备无法合并，注意分类

### 4. 装备保护

- 重要装备先装备上，防止误合并
- 合并前仔细检查装备信息
- 确认预览后再执行合并

## 游戏平衡性

### 优点

1. **装备循环**：提供装备升级路径
2. **策略深度**：需要权衡合并与保留
3. **随机性**：增加游戏可玩性
4. **清理机制**：处理多余装备

### 风险

1. **随机性**：可能得到不想要的装备
2. **等级重置**：新装备等级为1
3. **不可逆**：合并后无法恢复

### 平衡点

- 稀有度提升明显（+1）
- 需要势力和类型匹配（限制条件）
- 传奇装备无法合并（保护顶级装备）
- 已装备的装备无法合并（防止误操作）

## 示例场景

### 场景 1：合并两件损坏武器

```
装备1: 生锈的铁管 (损坏, 共和国)
装备2: 破损手枪 (损坏, 共和国)
↓
合并
↓
结果: 制式步枪 (普通, 共和国, Lv.1)
```

### 场景 2：合并不同稀有度

```
装备1: 制式步枪 (普通, 共和国)
装备2: 等离子光剑 (军用, 共和国)
↓
合并
↓
结果: 传奇狙击炮 (传奇, 共和国, Lv.1)
```

### 场景 3：合并失败 - 势力不同

```
装备1: 制式步枪 (普通, 共和国)
装备2: 等离子光剑 (军用, 帝国)
↓
合并失败：两件装备必须来自同一势力！
```

### 场景 4：合并失败 - 类型不同

```
装备1: 制式步枪 (普通, 共和国) [武器]
装备2: 反应堆外壳 (军用, 共和国) [装甲]
↓
合并失败：两件装备必须同时是武器或同时是装甲！
```

## 技术细节

### 随机数生成

```cpp
srand(time(nullptr));  // 使用当前时间作为种子
int randomIdx = rand() % factionEquipment.size();
```

**注意**：每次合并都会重新设置种子，确保随机性。

### 内存管理

```cpp
// 删除旧装备，防止内存泄漏
delete eq1;
delete eq2;

// 创建新装备
newEquipment = new Weapon(...);
```

### 指针安全

- 合并前检查装备是否已装备
- 使用 `dynamic_cast` 安全转换类型
- 删除前确保指针有效

## 未来改进建议

1. **合并预览增强**：显示可能获得的装备列表
2. **合并成功率**：不同稀有度不同成功率
3. **合并材料**：需要消耗特定材料
4. **定向合并**：选择想要的装备类型
5. **合并历史**：记录合并记录
6. **合并成就**：完成特定合并获得奖励

## 总结

装备合并系统为游戏增加了：
- ✅ 装备升级路径
- ✅ 策略深度
- ✅ 装备循环机制
- ✅ 背包管理功能

同时保持了：
- ✅ 合理的限制条件
- ✅ 清晰的用户反馈
- ✅ 良好的游戏平衡
- ✅ 安全的操作机制




